@page "/"
@using System.Text.Json
@using Community.Blazor.MapLibre.Models
@using Community.Blazor.MapLibre.Models.Control
@using Community.Blazor.MapLibre.Models.Feature
@using Community.Blazor.MapLibre.Models.Layers
@using Community.Blazor.MapLibre.Models.Sources
@using LayerHub.Shared.Dto
@using LayerHub.Shared.Dto.MapFeature
@using LayerHub.Web.Application.Services

@inject IHttpService HttpService

<PageTitle>Home</PageTitle>


<MapLibre @ref="Map" Options="_mapOptions" Class="rounded-top"
          Height="100vh" @rendermode="InteractiveServer" OnLoad="OnMapLoad"/>

@code
{
    private MapLibre Map { get; set; } = new MapLibre();
    
    private readonly MapOptions _mapOptions = new()
    {
        Container = "UniqueMapId",
        Style = "https://tiles.openfreemap.org/styles/liberty",
        Center = new LngLat()
        {
            Latitude = 48.725837, 
            Longitude = 18.752835
        },
        Zoom = 14, // Start with a default zoom level
        Pitch = 20
    };

    private async Task OnMapLoad(EventArgs obj)
    {
        var mapFeatures = (await HttpService.Get<PaginatedListDto<MapFeatureDto>>("/Feature?Page=1&ItemsPerPage=500&SortOrder=0"))
            .Items.Select(mf => new FeatureFeature()
            {
                Geometry = JsonSerializer.Deserialize<IGeometry>(mf.GeometryJson)
            }).ToList();

        await Map.AddControl(ControlType.FullscreenControl, ControlPosition.TopLeft);
        await Map.AddControl(ControlType.ScaleControl, ControlPosition.TopLeft);
        await Map.AddControl(ControlType.NavigationControl, ControlPosition.TopLeft);
        
        await Map.AddSource("all", new GeoJsonSource()
        {
            Data = new FeatureCollection()
            {
                Features = new List<IFeature>(mapFeatures)
            }
        });


        await Map.AddLayer(new FillLayer()
        {
            Id = "GeoJsonLayerId",
            Source = "all",
            Paint = new FillLayerPaint()
            {
                FillColor = "#088",
                FillOpacity = 0.8
            }
        });
    }
}
